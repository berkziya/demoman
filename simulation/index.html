<!doctype html>
<html lang="en-us">

<head>
  <meta charset="utf-8">
  <title>Verilator VGA Simulation</title>
  <style>
    html {
      box-sizing: border-box;
    }

    *,
    *::before,
    *::after {
      box-sizing: inherit;
    }

    body {
      font-family: Arial, sans-serif;
      margin: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      background-color: #333;
      color: #fff;
      line-height: 1.6;
    }

    .container {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
      max-width: 900px;
      width: 100%;
    }

    h1 {
      margin: 0 0 15px;
    }

    .emscripten_canvas_container {
      margin: 10px 0 15px;
      border: 2px solid #555;
      box-shadow: 0 0 12px rgba(0, 0, 0, 0.6);
      width: 640px;
      /* Match canvas HTML attributes */
      height: 480px;
      /* Match canvas HTML attributes */
      display: flex;
      justify-content: center;
      align-items: center;
      background-color: #111;
      /* Fallback if canvas is transparent or fails */
    }

    /* Canvas size is primarily set by its HTML width/height attributes for SDL */
    #canvas {
      display: block;
      /* Removes any potential extra space below if it were inline */
    }

    #status_text_area_container {
      width: 80%;
      max-width: 800px;
      display: flex;
      flex-direction: column;
      align-items: center;
      /* Centers children like status, title, textarea */
      margin-bottom: 15px;
    }

    #status,
    #controls_title {
      margin: 10px 0 5px;
      font-weight: bold;
    }

    #output {
      width: 100%;
      height: 150px;
      margin-top: 5px;
      background-color: #222;
      color: #ddd;
      border: 1px solid #555;
      padding: 8px;
      font-family: monospace;
      font-size: 0.9em;
      overflow-y: auto;
      /* Ensure scrollability */
    }

    .controls_section {
      margin-top: 15px;
      padding: 15px;
      background-color: #444;
      border-radius: 8px;
      border: 1px solid #555;
      width: 80%;
      max-width: 800px;
    }

    .controls_section h2 {
      margin: 0 0 10px;
      color: #ffa;
    }

    .controls_section ul {
      list-style-type: none;
      padding-left: 0;
      margin-top: 0;
      margin-bottom: 0;
    }

    .controls_section li {
      margin-bottom: 5px;
    }

    .controls_section code {
      background-color: #555;
      padding: 2px 5px;
      border-radius: 3px;
      font-family: monospace;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>Verilog VGA Simulation (WebAssembly)</h1>
    <div class="emscripten_canvas_container">
      <canvas id="canvas" width="640" height="480" oncontextmenu="event.preventDefault()"></canvas>
    </div>

    <div id="status_text_area_container">
      <p id="status">Loading...</p>
      <p id="controls_title">Console Output:</p>
      <textarea id="output" rows="10" readonly></textarea>
    </div>

    <div class="controls_section">
      <h2>Keyboard Controls</h2>
      <ul>
        <li><strong>Switches (Toggle):</strong>
          <ul>
            <li><code>1</code> to <code>9</code>: Toggle SW[9] down to SW[1] respectively</li>
            <li><code>0</code>: Toggle SW[0]</li>
          </ul>
        </li>
        <li><strong>Keys:</strong>
          <ul>
            <li><code>U</code>: KEY[3]</li>
            <li><code>I</code>: KEY[2]</li>
            <li><code>O</code>: KEY[1]</li>
            <li><code>P</code>: KEY[0]</li>
          </ul>
        </li>
        <li><code>Esc</code>: Stop simulation</li>
      </ul>
    </div>
  </div>

  <script type='text/javascript'>
    const statusElement = document.getElementById('status');
    const outputElement = document.getElementById('output');

    var Module = {
      preRun: [],
      postRun: [() => {
        if (statusElement) statusElement.textContent = 'Simulation Running.';
        const msg = "Emscripten module loaded and postRun executed.";
        console.log(msg);
        if (Module.print) Module.print(`WASM_SHELL: ${msg}`);
      }],
      // Standard functions for print/printErr to preserve `arguments` object behavior
      print: function (text) {
        if (arguments.length > 1) text = Array.prototype.slice.call(arguments).join(' ');
        console.log(text);
        if (outputElement) {
          outputElement.value += `${text}\n`;
          outputElement.scrollTop = outputElement.scrollHeight;
        }
      },
      printErr: function (text) {
        if (arguments.length > 1) text = Array.prototype.slice.call(arguments).join(' ');
        console.error(text);
        if (outputElement) {
          outputElement.value += `ERROR: ${text}\n`;
          outputElement.scrollTop = outputElement.scrollHeight;
        }
      },
      canvas: (() => {
        const canvas = document.getElementById('canvas');
        if (!canvas) {
          const errorMsg = "CRITICAL HTML ERROR: Canvas element with id 'canvas' not found!";
          console.error(errorMsg);
          alert(errorMsg);
          return null;
        }
        canvas.addEventListener("webglcontextlost", (e) => {
          alert('WebGL context lost. You will need to reload the page.');
          e.preventDefault();
        }, false);
        return canvas;
      })(),
      setStatus: function (text) { // Keep as function for Module.setStatus.last pattern
        if (!Module.setStatus.last) Module.setStatus.last = { time: Date.now(), text: '' };
        if (text === Module.setStatus.last.text) return;

        const m = text.match(/([^(]+)\((\d+(\.\d+)?)\/(\d+)\)/);
        const now = Date.now();
        if (m && now - Module.setStatus.last.time < 30) return; // Debounce progress updates

        Module.setStatus.last.time = now;
        Module.setStatus.last.text = text;
        if (statusElement) statusElement.textContent = text;
      },
      totalDependencies: 0,
      monitorRunDependencies: function (left) { // Keep as function for `this` context
        this.totalDependencies = Math.max(this.totalDependencies, left);
        Module.setStatus(left ? `Preparing... (${this.totalDependencies - left}/${this.totalDependencies})` : 'All downloads complete.');
      }
    };

    if (statusElement) Module.setStatus('Downloading...');

    window.onerror = (message, source, lineno, colno, errorObject) => {
      const errorText = `Exception: ${message || (errorObject && errorObject.message) || 'Unknown error'}${source ? ` at ${source}:${lineno}:${colno}` : ''}`;
      Module.setStatus('Exception thrown, see JavaScript console');
      // Ensure Module.printErr exists and is callable
      if (Module && typeof Module.printErr === 'function') {
        Module.printErr(errorText);
      } else {
        console.error(errorText); // Fallback to console.error
      }
      // return true; // Uncomment to prevent default browser error handling
    };
  </script>
  {{{ SCRIPT }}}
</body>

</html>